name: ECR KMS Cosign & Lifecycle Test

on:
  # ÊâãÂãïÂÆüË°å„ÇíÊúâÂäπÂåñ
  workflow_dispatch:
    inputs:
      image_count:
        description: 'Number of images to push per repository'
        required: false
        default: '15'
        type: string
      lifecycle_limit:
        description: 'Expected lifecycle limit (from Terraform)'
        required: false
        default: '10'
        type: string
  
  # „Éó„ÉÉ„Ç∑„É•ÊôÇ„Å´„ÇÇÂÆüË°åÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
  push:
    branches:
      - main
    paths:
      - 'app/**'
      - '.github/workflows/ecr-kms-lifecycle-test.yml'

# OIDCÁî®„ÅÆÊ®©Èôê
permissions:
  id-token: write   # AWS OIDCË™çË®ºÁî®
  contents: read    # „É™„Éù„Ç∏„Éà„É™„ÅÆË™≠„ÅøÂèñ„Çä

env:
  AWS_REGION: ap-northeast-1
  LIFECYCLE_LIMIT: ${{ inputs.lifecycle_limit || '10' }}
  IMAGE_COUNT: ${{ inputs.image_count || '15' }}

jobs:
  # ============================================================================
  # Job 1: Ë§áÊï∞„ÅÆ„Ç§„É°„Éº„Ç∏„Çí„Éì„É´„Éâ & „Éó„ÉÉ„Ç∑„É• & ÁΩ≤Âêç
  # ============================================================================
  build-push-sign:
    name: Build, Push & Sign
    runs-on: ubuntu-latest
    
    # Matrix strategy„Åß3„Å§„ÅÆ„Ç¢„Éó„É™„Çí‰∏¶ÂàóÂá¶ÁêÜ
    strategy:
      matrix:
        app: [sample-app-1, sample-app-2, sample-app-3]
      fail-fast: false  # 1„Å§Â§±Êïó„Åó„Å¶„ÇÇ‰ªñ„ÅØÁ∂ôÁ∂ö
    
    outputs:
      app-1-digest: ${{ steps.push-app-1.outputs.digest }}
      app-2-digest: ${{ steps.push-app-2.outputs.digest }}
      app-3-digest: ${{ steps.push-app-3.outputs.digest }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: github-actions-${{ github.run_id }}
      
      - name: Verify AWS identity
        run: |
          echo "=== AWS Identity ==="
          aws sts get-caller-identity
          echo ""
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3
        with:
          cosign-release: 'v2.2.4'
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # Ë§áÊï∞„ÅÆ„Ç§„É°„Éº„Ç∏„ÇíÈÄ£Á∂ö„Éì„É´„Éâ & „Éó„ÉÉ„Ç∑„É•
      - name: Build and push multiple images
        id: build-push
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ matrix.app }}
          IMAGE_COUNT: ${{ env.IMAGE_COUNT }}
        run: |
          echo "=== Building $IMAGE_COUNT images for $ECR_REPOSITORY ==="
          
          # ÁµêÊûú„Çí‰øùÂ≠ò„Åô„Çã„Éï„Ç°„Ç§„É´
          RESULTS_FILE="build-results-$ECR_REPOSITORY.json"
          echo '{"images": []}' > $RESULTS_FILE
          
          for i in $(seq 1 $IMAGE_COUNT); do
            IMAGE_TAG=$(printf "workflow-%s-%03d" "${{ github.run_number }}" $i)
            IMAGE_URI="$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
            
            echo "[$i/$IMAGE_COUNT] Building and pushing: $IMAGE_TAG"
            
            # Dockerfile„ÇíÂãïÁöÑÁîüÊàêÔºàÂêÑ„Ç§„É°„Éº„Ç∏„ÇíÁï∞„Å™„ÇãÂÜÖÂÆπ„Å´„Åô„ÇãÔºâ
            mkdir -p /tmp/build-$i
            cat > /tmp/build-$i/Dockerfile << EOF
          FROM alpine:latest
          
          LABEL org.opencontainers.image.source="https://github.com/${{ github.repository }}"
          LABEL org.opencontainers.image.revision="${{ github.sha }}"
          LABEL org.opencontainers.image.created="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          
          RUN echo "Repository: $ECR_REPOSITORY" > /image-info.txt && \
              echo "Image number: $i" >> /image-info.txt && \
              echo "Workflow run: ${{ github.run_number }}" >> /image-info.txt && \
              echo "Git SHA: ${{ github.sha }}" >> /image-info.txt && \
              echo "Build time: \$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> /image-info.txt && \
              echo "Random: \$RANDOM" >> /image-info.txt
          
          CMD cat /image-info.txt
          EOF
            
            # „Éì„É´„Éâ & „Éó„ÉÉ„Ç∑„É•
            docker build -t $IMAGE_URI /tmp/build-$i
            docker push $IMAGE_URI
            
            # „ÉÄ„Ç§„Ç∏„Çß„Çπ„Éà„ÇíÂèñÂæó
            DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' $IMAGE_URI | cut -d'@' -f2)
            IMAGE_WITH_DIGEST="$ECR_REGISTRY/$ECR_REPOSITORY@$DIGEST"
            
            echo "  Digest: $DIGEST"
            
            # ÁµêÊûú„ÇíJSONÈÖçÂàó„Å´ËøΩÂä†
            jq --arg tag "$IMAGE_TAG" \
               --arg digest "$DIGEST" \
               --arg uri "$IMAGE_WITH_DIGEST" \
               '.images += [{"tag": $tag, "digest": $digest, "uri": $uri}]' \
               $RESULTS_FILE > tmp.$$ && mv tmp.$$ $RESULTS_FILE
            
            # ÁΩ≤ÂêçÔºà„Éó„É©„Ç§„Éô„Éº„ÉàECRÁî®ÔºöRekor„Å∏„ÅÆ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Çí„Çπ„Ç≠„ÉÉ„ÉóÔºâ
            echo "  Signing..."
            cosign sign --key awskms:///${{ secrets.KMS_KEY_ARN }} \
              --annotations="workflow-run=${{ github.run_number }}" \
              --annotations="git-sha=${{ github.sha }}" \
              --annotations="repository=$ECR_REPOSITORY" \
              --annotations="image-number=$i" \
              --yes \
              --tlog-upload=false \
              $IMAGE_WITH_DIGEST
            
            echo "  ‚úì Completed: $IMAGE_TAG"
            echo ""
          done
          
          echo "=== All images built and signed ==="
          cat $RESULTS_FILE | jq .
          
          # „Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„ÉàÁî®„Å´‰øùÂ≠ò
          mkdir -p results
          cp $RESULTS_FILE results/
      
      - name: Verify signatures
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ matrix.app }}
        run: |
          echo "=== Verifying signatures ==="
          
          RESULTS_FILE="build-results-$ECR_REPOSITORY.json"
          VERIFY_RESULTS="verify-results-$ECR_REPOSITORY.json"
          echo '{"verifications": []}' > $VERIFY_RESULTS
          
          # ÂêÑ„Ç§„É°„Éº„Ç∏„ÅÆÁΩ≤Âêç„ÇíÊ§úË®ºÔºà„Éó„É©„Ç§„Éô„Éº„ÉàECRÁî®ÔºöTransparency LogÊ§úË®º„Çí„Çπ„Ç≠„ÉÉ„ÉóÔºâ
          for uri in $(jq -r '.images[].uri' $RESULTS_FILE); do
            echo "Verifying: $uri"
            
            if cosign verify --key awskms:///${{ secrets.KMS_KEY_ARN }} --insecure-ignore-tlog $uri > /dev/null 2>&1; then
              echo "  ‚úì Signature valid"
              STATUS="valid"
            else
              echo "  ‚úó Signature invalid"
              STATUS="invalid"
            fi
            
            jq --arg uri "$uri" \
               --arg status "$STATUS" \
               '.verifications += [{"uri": $uri, "status": $status}]' \
               $VERIFY_RESULTS > tmp.$$ && mv tmp.$$ $VERIFY_RESULTS
          done
          
          echo "=== Verification Results ==="
          cat $VERIFY_RESULTS | jq .
          
          # ÁµêÊûú„Çí‰øùÂ≠ò
          cp $VERIFY_RESULTS results/
      
      - name: Upload build results
        uses: actions/upload-artifact@v4
        with:
          name: build-results-${{ matrix.app }}
          path: results/
          retention-days: 30
  
  # ============================================================================
  # Job 2: „É©„Ç§„Éï„Çµ„Ç§„ÇØ„É´„Éù„É™„Ç∑„Éº„ÅÆÊ§úË®º
  # ============================================================================
  verify-lifecycle:
    name: Verify Lifecycle Policy
    runs-on: ubuntu-latest
    needs: build-push-sign
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Check image counts
        id: check-counts
        run: |
          echo "=== ECR Image Count Check ==="
          
          REPOS=("sample-app-1" "sample-app-2" "sample-app-3")
          RESULTS_FILE="lifecycle-results.json"
          echo '{"repositories": []}' > $RESULTS_FILE
          
          for repo in "${REPOS[@]}"; do
            echo ""
            echo "Repository: $repo"
            
            # „Ç§„É°„Éº„Ç∏Êï∞„ÇíÂèñÂæó
            IMAGE_COUNT=$(aws ecr describe-images \
              --repository-name $repo \
              --region ${{ env.AWS_REGION }} \
              --query 'length(imageDetails)' \
              --output text)
            
            echo "  Total images: $IMAGE_COUNT"
            echo "  Lifecycle limit: ${{ env.LIFECYCLE_LIMIT }}"
            
            # Áä∂ÊÖãÂà§ÂÆö
            if [ "$IMAGE_COUNT" -le "${{ env.LIFECYCLE_LIMIT }}" ]; then
              STATUS="within_limit"
              MESSAGE="‚úì Within lifecycle limit"
            else
              EXCESS=$((IMAGE_COUNT - ${{ env.LIFECYCLE_LIMIT }}))
              STATUS="exceeds_limit"
              MESSAGE="! Exceeds limit by $EXCESS (auto-deletion pending)"
            fi
            
            echo "  Status: $MESSAGE"
            
            # ÁµêÊûú„ÇíJSON„Å´ËøΩÂä†
            jq --arg repo "$repo" \
               --arg count "$IMAGE_COUNT" \
               --arg limit "${{ env.LIFECYCLE_LIMIT }}" \
               --arg status "$STATUS" \
               --arg message "$MESSAGE" \
               '.repositories += [{"name": $repo, "image_count": ($count | tonumber), "lifecycle_limit": ($limit | tonumber), "status": $status, "message": $message}]' \
               $RESULTS_FILE > tmp.$$ && mv tmp.$$ $RESULTS_FILE
          done
          
          echo ""
          echo "=== Summary ==="
          cat $RESULTS_FILE | jq .
          
          # GitHub Actions„ÅÆÂá∫Âäõ„Å´Ë®≠ÂÆö
          echo "results<<EOF" >> $GITHUB_OUTPUT
          cat $RESULTS_FILE >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # „Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„ÉàÁî®
          mkdir -p results
          cp $RESULTS_FILE results/
      
      - name: Generate detailed report
        run: |
          echo "=== Detailed Image Report ==="
          
          REPORT_FILE="results/detailed-report.md"
          mkdir -p results
          
          cat > $REPORT_FILE << 'EOF'
          # ECR Lifecycle Test Report
          
          ## Test Information
          
          - **Workflow Run**: ${{ github.run_number }}
          - **Git SHA**: ${{ github.sha }}
          - **Timestamp**: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          - **Images per repository**: ${{ env.IMAGE_COUNT }}
          - **Lifecycle limit**: ${{ env.LIFECYCLE_LIMIT }}
          
          ## Repository Status
          
          EOF
          
          # ÂêÑ„É™„Éù„Ç∏„Éà„É™„ÅÆË©≥Á¥∞
          for repo in sample-app-1 sample-app-2 sample-app-3; do
            echo "" >> $REPORT_FILE
            echo "### Repository: $repo" >> $REPORT_FILE
            echo "" >> $REPORT_FILE
            
            # „Ç§„É°„Éº„Ç∏‰∏ÄË¶ß
            echo "#### Images (sorted by push time)" >> $REPORT_FILE
            echo "" >> $REPORT_FILE
            echo '```' >> $REPORT_FILE
            aws ecr describe-images \
              --repository-name $repo \
              --region ${{ env.AWS_REGION }} \
              --query 'sort_by(imageDetails,& imagePushedAt)[*].[imageTags[0] || `<untagged>`, imagePushedAt, imageSizeInBytes]' \
              --output table >> $REPORT_FILE
            echo '```' >> $REPORT_FILE
            echo "" >> $REPORT_FILE
            
            # ÁΩ≤Âêç„Ç§„É°„Éº„Ç∏„ÅÆÁ¢∫Ë™ç
            echo "#### Signature Images" >> $REPORT_FILE
            echo "" >> $REPORT_FILE
            SIG_COUNT=$(aws ecr describe-images \
              --repository-name $repo \
              --region ${{ env.AWS_REGION }} \
              --query 'length(imageDetails[?imageTags && contains(to_string(imageTags), `.sig`)])' \
              --output text)
            echo "- Signature images: $SIG_COUNT" >> $REPORT_FILE
            echo "" >> $REPORT_FILE
          done
          
          # „É©„Ç§„Éï„Çµ„Ç§„ÇØ„É´„Éù„É™„Ç∑„Éº
          echo "## Lifecycle Policy" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo '```json' >> $REPORT_FILE
          aws ecr get-lifecycle-policy \
            --repository-name sample-app-1 \
            --region ${{ env.AWS_REGION }} \
            --query 'lifecyclePolicyText' \
            --output text >> $REPORT_FILE
          echo '```' >> $REPORT_FILE
          
          echo "" >> $REPORT_FILE
          echo "## Notes" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "- Lifecycle policies are evaluated every 24 hours" >> $REPORT_FILE
          echo "- Images exceeding the limit will be deleted automatically" >> $REPORT_FILE
          echo "- This report shows the state immediately after pushing images" >> $REPORT_FILE
          
          cat $REPORT_FILE
      
      - name: Upload lifecycle results
        uses: actions/upload-artifact@v4
        with:
          name: lifecycle-results
          path: results/
          retention-days: 30
  
  # ============================================================================
  # Job 3: GitHub Summary‰ΩúÊàê
  # ============================================================================
  create-summary:
    name: Create Summary
    runs-on: ubuntu-latest
    needs: [build-push-sign, verify-lifecycle]
    if: always()
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-results
      
      - name: Generate GitHub Summary
        run: |
          echo "# üéØ ECR KMS Cosign & Lifecycle Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## üìä Test Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow Run | \`${{ github.run_number }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Git SHA | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Timestamp | $(date -u +%Y-%m-%dT%H:%M:%SZ) |" >> $GITHUB_STEP_SUMMARY
          echo "| Images per repo | ${{ env.IMAGE_COUNT }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lifecycle limit | ${{ env.LIFECYCLE_LIMIT }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## üì¶ Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ÂêÑ„Ç¢„Éó„É™„ÅÆ„Éì„É´„ÉâÁµêÊûú„ÇíË°®Á§∫
          for app in sample-app-1 sample-app-2 sample-app-3; do
            if [ -f "all-results/build-results-$app/build-results-$app.json" ]; then
              echo "### $app" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              IMAGE_COUNT=$(jq '.images | length' "all-results/build-results-$app/build-results-$app.json")
              echo "- **Images built**: $IMAGE_COUNT" >> $GITHUB_STEP_SUMMARY
              
              # Ê§úË®ºÁµêÊûú
              if [ -f "all-results/build-results-$app/verify-results-$app.json" ]; then
                VALID_COUNT=$(jq '[.verifications[] | select(.status == "valid")] | length' "all-results/build-results-$app/verify-results-$app.json")
                echo "- **Signatures verified**: ‚úÖ $VALID_COUNT/$IMAGE_COUNT" >> $GITHUB_STEP_SUMMARY
              fi
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "## üîÑ Lifecycle Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "all-results/lifecycle-results/lifecycle-results.json" ]; then
            echo "| Repository | Image Count | Lifecycle Limit | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|------------|-------------|-----------------|--------|" >> $GITHUB_STEP_SUMMARY
            
            jq -r '.repositories[] | "| \(.name) | \(.image_count) | \(.lifecycle_limit) | \(.message) |"' \
              all-results/lifecycle-results/lifecycle-results.json >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "## ‚ö†Ô∏è Important Notes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Lifecycle policies are evaluated every **24 hours**" >> $GITHUB_STEP_SUMMARY
          echo "- Images exceeding the limit will be deleted automatically" >> $GITHUB_STEP_SUMMARY
          echo "- Signature images are also counted as separate images" >> $GITHUB_STEP_SUMMARY
          echo "- Check the detailed report in artifacts for more information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## üìÅ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Build results: \`build-results-sample-app-*\`" >> $GITHUB_STEP_SUMMARY
          echo "- Lifecycle results: \`lifecycle-results\`" >> $GITHUB_STEP_SUMMARY
          echo "- Detailed report: \`detailed-report.md\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Check for failures
        run: |
          # Â§±Êïó„Åó„Åü„Ç∏„Éß„Éñ„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
          if [ "${{ needs.build-push-sign.result }}" != "success" ]; then
            echo "‚ö†Ô∏è Build, push, or sign job failed"
            exit 1
          fi
          
          if [ "${{ needs.verify-lifecycle.result }}" != "success" ]; then
            echo "‚ö†Ô∏è Lifecycle verification job failed"
            exit 1
          fi
          
          echo "‚úÖ All tests passed successfully"

