name: Single Image Build, Sign & Verify

on:
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      repository_name:
        description: 'ECR repository name'
        required: true
        type: choice
        options:
          - sample-app-1
          - sample-app-2
          - sample-app-3
      image_count:
        description: 'Number of images to push'
        required: false
        default: '5'
        type: string
      image_tag_prefix:
        description: 'Image tag prefix (optional)'
        required: false
        default: 'test'
        type: string

# OIDCç”¨ã®æ¨©é™
permissions:
  id-token: write   # AWS OIDCèªè¨¼ç”¨
  contents: read    # ãƒªãƒã‚¸ãƒˆãƒªã®èª­ã¿å–ã‚Š

env:
  AWS_REGION: ap-northeast-1

jobs:
  build-sign-verify:
    name: Build, Sign & Verify
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set workflow variables
        id: vars
        run: |
          echo "repository=${{ inputs.repository_name }}" >> $GITHUB_OUTPUT
          echo "image_count=${{ inputs.image_count }}" >> $GITHUB_OUTPUT
          echo "tag_prefix=${{ inputs.image_tag_prefix }}" >> $GITHUB_OUTPUT
          echo "run_id=${{ github.run_number }}" >> $GITHUB_OUTPUT
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: github-actions-${{ github.run_id }}
      
      - name: Verify AWS identity
        run: |
          echo "=== AWS Identity ==="
          aws sts get-caller-identity
          echo ""
          echo "=== Target Configuration ==="
          echo "Repository: ${{ steps.vars.outputs.repository }}"
          echo "Image Count: ${{ steps.vars.outputs.image_count }}"
          echo "Tag Prefix: ${{ steps.vars.outputs.tag_prefix }}"
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3
        with:
          cosign-release: 'v3.0.2'
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Check initial image count
        id: initial-check
        env:
          ECR_REPOSITORY: ${{ steps.vars.outputs.repository }}
        run: |
          echo "=== Initial State ==="
          
          INITIAL_COUNT=$(aws ecr describe-images \
            --repository-name $ECR_REPOSITORY \
            --region ${{ env.AWS_REGION }} \
            --query 'length(imageDetails)' \
            --output text 2>/dev/null || echo "0")
          
          echo "Initial image count: $INITIAL_COUNT"
          echo "initial_count=$INITIAL_COUNT" >> $GITHUB_OUTPUT
          
          # ã‚¤ãƒ¡ãƒ¼ã‚¸ä¸€è¦§ã‚’è¡¨ç¤ºï¼ˆæœ€æ–°10ä»¶ï¼‰
          echo ""
          echo "Current images (latest 10):"
          aws ecr describe-images \
            --repository-name $ECR_REPOSITORY \
            --region ${{ env.AWS_REGION }} \
            --query 'reverse(sort_by(imageDetails,& imagePushedAt))[0:10].[imageTags[0] || `<untagged>`, imagePushedAt]' \
            --output table 2>/dev/null || echo "No images found"
      
      - name: Build and push images
        id: build-push
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ steps.vars.outputs.repository }}
          IMAGE_COUNT: ${{ steps.vars.outputs.image_count }}
          TAG_PREFIX: ${{ steps.vars.outputs.tag_prefix }}
          RUN_ID: ${{ steps.vars.outputs.run_id }}
        run: |
          echo "=== Building $IMAGE_COUNT images for $ECR_REPOSITORY ==="
          
          # çµæžœã‚’ä¿å­˜
          RESULTS_FILE="build-results.json"
          echo '{"repository": "'$ECR_REPOSITORY'", "images": []}' > $RESULTS_FILE
          
          for i in $(seq 1 $IMAGE_COUNT); do
            IMAGE_TAG=$(printf "${TAG_PREFIX}-%s-%03d" "$RUN_ID" $i)
            IMAGE_URI="$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
            
            echo ""
            echo "[$i/$IMAGE_COUNT] Building: $IMAGE_TAG"
            
            # Dockerfileã‚’å‹•çš„ç”Ÿæˆ
            BUILD_DIR="/tmp/build-$i"
            mkdir -p $BUILD_DIR
            
            cat > $BUILD_DIR/Dockerfile << EOF
          FROM alpine:latest
          
          LABEL org.opencontainers.image.source="https://github.com/${{ github.repository }}"
          LABEL org.opencontainers.image.revision="${{ github.sha }}"
          LABEL org.opencontainers.image.created="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          LABEL app.repository="$ECR_REPOSITORY"
          LABEL app.image.number="$i"
          
          RUN echo "=== Image Information ===" > /image-info.txt && \
              echo "Repository: $ECR_REPOSITORY" >> /image-info.txt && \
              echo "Image number: $i of $IMAGE_COUNT" >> /image-info.txt && \
              echo "Workflow run: $RUN_ID" >> /image-info.txt && \
              echo "Git SHA: ${{ github.sha }}" >> /image-info.txt && \
              echo "Tag: $IMAGE_TAG" >> /image-info.txt && \
              echo "Build time: \$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> /image-info.txt && \
              echo "Random ID: \$RANDOM" >> /image-info.txt && \
              echo "========================" >> /image-info.txt
          
          CMD cat /image-info.txt
          EOF
            
            # ãƒ“ãƒ«ãƒ‰
            echo "  Building..."
            docker build -t $IMAGE_URI $BUILD_DIR
            
            # ãƒ—ãƒƒã‚·ãƒ¥
            echo "  Pushing..."
            docker push $IMAGE_URI
            
            # ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆã‚’å–å¾—
            DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' $IMAGE_URI | cut -d'@' -f2)
            IMAGE_WITH_DIGEST="$ECR_REGISTRY/$ECR_REPOSITORY@$DIGEST"
            
            echo "  Digest: $DIGEST"
            
            # çµæžœã‚’JSONé…åˆ—ã«è¿½åŠ 
            jq --arg tag "$IMAGE_TAG" \
               --arg digest "$DIGEST" \
               --arg uri "$IMAGE_WITH_DIGEST" \
               --arg number "$i" \
               '.images += [{"number": ($number | tonumber), "tag": $tag, "digest": $digest, "uri": $uri}]' \
               $RESULTS_FILE > tmp.$$ && mv tmp.$$ $RESULTS_FILE
            
            echo "  âœ“ Completed: $IMAGE_TAG"
          done
          
          echo ""
          echo "=== Build Complete ==="
          echo "Repository: $ECR_REPOSITORY"
          echo "Images built: $IMAGE_COUNT"
          cat $RESULTS_FILE | jq .
          
          # GitHub output
          echo "results_file=$RESULTS_FILE" >> $GITHUB_OUTPUT
      
      - name: Sign images with Cosign
        id: sign-images-with-cosign
        env:
          KMS_KEY_ARN: ${{ secrets.KMS_KEY_ARN }}
          ECR_REPOSITORY: ${{ steps.vars.outputs.repository }}
        run: |
          echo "=== Signing images with Cosign ==="
          
          RESULTS_FILE="${{ steps.build-push.outputs.results_file }}"
          SIGN_RESULTS="signature-results.json"
          echo '{"signatures": []}' > $SIGN_RESULTS
          
          IMAGE_COUNT=$(jq '.images | length' $RESULTS_FILE)
          
          for i in $(seq 0 $((IMAGE_COUNT - 1))); do
            URI=$(jq -r ".images[$i].uri" $RESULTS_FILE)
            TAG=$(jq -r ".images[$i].tag" $RESULTS_FILE)
            NUM=$(jq -r ".images[$i].number" $RESULTS_FILE)
            
            echo ""
            echo "[$((i + 1))/$IMAGE_COUNT] Signing: $TAG"
            echo "  URI: $URI"
            
            # ç½²å
            if cosign sign --key awskms:///$KMS_KEY_ARN \
              --annotations="workflow-run=${{ github.run_number }}" \
              --annotations="git-sha=${{ github.sha }}" \
              --annotations="repository=$ECR_REPOSITORY" \
              --annotations="image-number=$NUM" \
              --annotations="tag=$TAG" \
              --yes \
              $URI; then
              echo "  âœ“ Signed successfully"
              STATUS="signed"
            else
              echo "  âœ— Signing failed"
              STATUS="failed"
            fi
            
            # çµæžœã‚’è¨˜éŒ²
            jq --arg uri "$URI" \
               --arg tag "$TAG" \
               --arg status "$STATUS" \
               '.signatures += [{"uri": $uri, "tag": $tag, "status": $status}]' \
               $SIGN_RESULTS > tmp.$$ && mv tmp.$$ $SIGN_RESULTS
          done
          
          echo ""
          echo "=== Signing Complete ==="
          cat $SIGN_RESULTS | jq .
          
          # GitHub output
          echo "sign_results_file=$SIGN_RESULTS" >> $GITHUB_OUTPUT
      
      - name: Verify signatures
        id: verify-signatures
        env:
          KMS_KEY_ARN: ${{ secrets.KMS_KEY_ARN }}
        run: |
          echo "=== Verifying signatures ==="
          
          RESULTS_FILE="${{ steps.build-push.outputs.results_file }}"
          VERIFY_RESULTS="verification-results.json"
          echo '{"verifications": []}' > $VERIFY_RESULTS
          
          IMAGE_COUNT=$(jq '.images | length' $RESULTS_FILE)
          VALID_COUNT=0
          INVALID_COUNT=0
          
          for i in $(seq 0 $((IMAGE_COUNT - 1))); do
            URI=$(jq -r ".images[$i].uri" $RESULTS_FILE)
            TAG=$(jq -r ".images[$i].tag" $RESULTS_FILE)
            
            echo ""
            echo "[$((i + 1))/$IMAGE_COUNT] Verifying: $TAG"
            
            # æ¤œè¨¼
            if cosign verify --key awskms:///$KMS_KEY_ARN $URI > /dev/null 2>&1; then
              echo "  âœ“ Signature valid"
              STATUS="valid"
              VALID_COUNT=$((VALID_COUNT + 1))
            else
              echo "  âœ— Signature invalid"
              STATUS="invalid"
              INVALID_COUNT=$((INVALID_COUNT + 1))
            fi
            
            # çµæžœã‚’è¨˜éŒ²
            jq --arg uri "$URI" \
               --arg tag "$TAG" \
               --arg status "$STATUS" \
               '.verifications += [{"uri": $uri, "tag": $tag, "status": $status}]' \
               $VERIFY_RESULTS > tmp.$$ && mv tmp.$$ $VERIFY_RESULTS
          done
          
          echo ""
          echo "=== Verification Complete ==="
          echo "Valid signatures: $VALID_COUNT/$IMAGE_COUNT"
          echo "Invalid signatures: $INVALID_COUNT/$IMAGE_COUNT"
          cat $VERIFY_RESULTS | jq .
          
          # GitHub output
          echo "verify_results_file=$VERIFY_RESULTS" >> $GITHUB_OUTPUT
          echo "valid_count=$VALID_COUNT" >> $GITHUB_OUTPUT
          echo "invalid_count=$INVALID_COUNT" >> $GITHUB_OUTPUT
          
          # æ¤œè¨¼å¤±æ•—ãŒã‚ã‚Œã°ã‚¨ãƒ©ãƒ¼
          if [ $INVALID_COUNT -gt 0 ]; then
            echo "::error::Some signatures failed verification"
            exit 1
          fi
      
      - name: Check final image count
        id: final-check
        env:
          ECR_REPOSITORY: ${{ steps.vars.outputs.repository }}
        run: |
          echo "=== Final State ==="
          
          FINAL_COUNT=$(aws ecr describe-images \
            --repository-name $ECR_REPOSITORY \
            --region ${{ env.AWS_REGION }} \
            --query 'length(imageDetails)' \
            --output text)
          
          INITIAL_COUNT=${{ steps.initial-check.outputs.initial_count }}
          IMAGE_COUNT=${{ steps.vars.outputs.image_count }}
          
          echo "Initial count: $INITIAL_COUNT"
          echo "Images pushed: $IMAGE_COUNT"
          echo "Final count: $FINAL_COUNT"
          echo "Expected: $((INITIAL_COUNT + IMAGE_COUNT))"
          
          # ç½²åã‚¤ãƒ¡ãƒ¼ã‚¸ã®æ•°ã‚’ç¢ºèª
          SIG_COUNT=$(aws ecr describe-images \
            --repository-name $ECR_REPOSITORY \
            --region ${{ env.AWS_REGION }} \
            --query 'length(imageDetails[?imageTags && contains(to_string(imageTags), `.sig`)])' \
            --output text)
          
          echo "Signature images: $SIG_COUNT"
          
          # çµæžœã‚’GitHub outputã«
          echo "final_count=$FINAL_COUNT" >> $GITHUB_OUTPUT
          echo "signature_count=$SIG_COUNT" >> $GITHUB_OUTPUT
          
          # ã‚¤ãƒ¡ãƒ¼ã‚¸ä¸€è¦§
          echo ""
          echo "Latest 15 images:"
          aws ecr describe-images \
            --repository-name $ECR_REPOSITORY \
            --region ${{ env.AWS_REGION }} \
            --query 'reverse(sort_by(imageDetails,& imagePushedAt))[0:15].[imageTags[0] || `<untagged>`, imagePushedAt]' \
            --output table
      
      - name: Generate test report
        env:
          REPOSITORY: ${{ steps.vars.outputs.repository }}
          IMAGE_COUNT: ${{ steps.vars.outputs.image_count }}
          TAG_PREFIX: ${{ steps.vars.outputs.tag_prefix }}
          INITIAL_COUNT: ${{ steps.initial-check.outputs.initial_count }}
          FINAL_COUNT: ${{ steps.final-check.outputs.final_count }}
          SIG_COUNT: ${{ steps.final-check.outputs.signature_count }}
          VALID_COUNT: ${{ steps.verify-signatures.outputs.valid_count }}
          INVALID_COUNT: ${{ steps.verify-signatures.outputs.invalid_count }}
          BUILD_RESULTS: ${{ steps.build-push.outputs.results_file }}
          SIGN_RESULTS: ${{ steps.sign-images-with-cosign.outputs.sign_results_file }}
          VERIFY_RESULTS: ${{ steps.verify-signatures.outputs.verify_results_file }}
        run: |
          echo "=== Generating Test Report ==="
          
          mkdir -p results
          REPORT_FILE="results/test-report.md"
          
          # æˆåŠŸçŽ‡ã‚’è¨ˆç®—
          SUCCESS_RATE=$(( VALID_COUNT * 100 / IMAGE_COUNT ))
          
          # ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
          cat > $REPORT_FILE << 'REPORT_EOF'
          # Single Image Test Report
          
          ## Test Configuration
          REPORT_EOF
          
          echo "" >> $REPORT_FILE
          echo "- **Repository**: $REPOSITORY" >> $REPORT_FILE
          echo "- **Images pushed**: $IMAGE_COUNT" >> $REPORT_FILE
          echo "- **Tag prefix**: $TAG_PREFIX" >> $REPORT_FILE
          echo "- **Workflow run**: ${{ github.run_number }}" >> $REPORT_FILE
          echo "- **Git SHA**: ${{ github.sha }}" >> $REPORT_FILE
          echo "- **Timestamp**: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          
          echo "## Results" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "### Image Counts" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "- **Initial**: $INITIAL_COUNT" >> $REPORT_FILE
          echo "- **Pushed**: $IMAGE_COUNT" >> $REPORT_FILE
          echo "- **Final**: $FINAL_COUNT" >> $REPORT_FILE
          echo "- **Signatures**: $SIG_COUNT" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          
          echo "### Verification" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "- **Valid signatures**: $VALID_COUNT" >> $REPORT_FILE
          echo "- **Invalid signatures**: $INVALID_COUNT" >> $REPORT_FILE
          echo "- **Success rate**: ${SUCCESS_RATE}%" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          
          echo "## Images" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "### Build Results" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo '```json' >> $REPORT_FILE
          cat $BUILD_RESULTS | jq . >> $REPORT_FILE
          echo '```' >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          
          echo "### Signature Results" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo '```json' >> $REPORT_FILE
          cat $SIGN_RESULTS | jq . >> $REPORT_FILE
          echo '```' >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          
          echo "### Verification Results" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo '```json' >> $REPORT_FILE
          cat $VERIFY_RESULTS | jq . >> $REPORT_FILE
          echo '```' >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          
          echo "## Repository State" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo '```' >> $REPORT_FILE
          aws ecr describe-images \
            --repository-name $REPOSITORY \
            --region ${{ env.AWS_REGION }} \
            --query 'sort_by(imageDetails,& imagePushedAt)[*].[imageTags[0] || `<untagged>`, imagePushedAt, imageSizeInBytes]' \
            --output table >> $REPORT_FILE
          echo '```' >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          
          echo "## Notes" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "- Images are signed using AWS KMS key" >> $REPORT_FILE
          echo "- Signatures are stored in the same ECR repository with \`.sig\` suffix" >> $REPORT_FILE
          echo "- Both images and signatures count toward the total image count" >> $REPORT_FILE
          
          cat $REPORT_FILE
      
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: single-image-test-results-${{ steps.vars.outputs.repository }}
          path: |
            build-results.json
            signature-results.json
            verification-results.json
            results/test-report.md
          retention-days: 30
      
      - name: Generate GitHub Summary
        if: always()
        run: |
          echo "# ðŸŽ¯ Single Image Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ“Š Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | \`${{ steps.vars.outputs.repository }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Images pushed | ${{ steps.vars.outputs.image_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag prefix | \`${{ steps.vars.outputs.tag_prefix }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow run | \`${{ github.run_number }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Git SHA | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ“¦ Image Counts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Type | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Initial | ${{ steps.initial-check.outputs.initial_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pushed | ${{ steps.vars.outputs.image_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Final | ${{ steps.final-check.outputs.final_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Signatures | ${{ steps.final-check.outputs.signature_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## âœ… Verification Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          VALID=${{ steps.verify-signatures.outputs.valid_count }}
          INVALID=${{ steps.verify-signatures.outputs.invalid_count }}
          TOTAL=${{ steps.vars.outputs.image_count }}
          
          if [ $INVALID -eq 0 ]; then
            echo "**Status**: âœ… All signatures verified successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status**: âš ï¸ Some signatures failed verification" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Valid**: âœ… $VALID/$TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "- **Invalid**: âŒ $INVALID/$TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "- **Success rate**: $(( VALID * 100 / TOTAL ))%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ“ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Build results: \`build-results.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- Signature results: \`signature-results.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- Verification results: \`verification-results.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- Detailed report: \`test-report.md\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ”— Useful Commands" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Check current image count" >> $GITHUB_STEP_SUMMARY
          echo "aws ecr describe-images \\" >> $GITHUB_STEP_SUMMARY
          echo "  --repository-name ${{ steps.vars.outputs.repository }} \\" >> $GITHUB_STEP_SUMMARY
          echo "  --query 'length(imageDetails)' \\" >> $GITHUB_STEP_SUMMARY
          echo "  --output text" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# List images" >> $GITHUB_STEP_SUMMARY
          echo "aws ecr describe-images \\" >> $GITHUB_STEP_SUMMARY
          echo "  --repository-name ${{ steps.vars.outputs.repository }} \\" >> $GITHUB_STEP_SUMMARY
          echo "  --query 'sort_by(imageDetails,& imagePushedAt)[*].[imageTags[0], imagePushedAt]' \\" >> $GITHUB_STEP_SUMMARY
          echo "  --output table" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
      
      - name: Final check
        run: |
          echo "=== Test Summary ==="
          echo "âœ… Repository: ${{ steps.vars.outputs.repository }}"
          echo "âœ… Images built and pushed: ${{ steps.vars.outputs.image_count }}"
          echo "âœ… All images signed with Cosign"
          echo "âœ… All signatures verified: ${{ steps.verify-signatures.outputs.valid_count }}/${{ steps.vars.outputs.image_count }}"
          echo ""
          echo "Test completed successfully! ðŸŽ‰"

